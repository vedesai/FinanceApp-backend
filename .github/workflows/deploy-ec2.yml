name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  JAVA_VERSION: 17

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Create deployment package
        run: |
          mkdir -p deploy-package
          cp target/finance-backend-*.jar deploy-package/finance-backend.jar
          if [ -f scripts/deploy.sh ]; then
            cp scripts/deploy.sh deploy-package/
          fi
          if [ -f scripts/finance-app.service ]; then
            cp scripts/finance-app.service deploy-package/
          fi
          # Create tar archive by listing files explicitly to avoid permission issues
          (cd deploy-package && tar -czf ../deploy-package.tar.gz finance-backend.jar finance-app.service deploy.sh 2>/dev/null || \
           cd deploy-package && tar -czf ../deploy-package.tar.gz finance-backend.jar finance-app.service 2>/dev/null || \
           cd deploy-package && tar -czf ../deploy-package.tar.gz finance-backend.jar)

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          scp -i ~/.ssh/deploy_key \
              deploy-package.tar.gz \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/
          
          ssh -i ~/.ssh/deploy_key \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
              'bash -s' << 'EOF'
            set -e
            DEPLOY_DIR="/opt/finance-app"
            BACKUP_DIR="/opt/finance-app/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            # Create directories if they don't exist
            sudo mkdir -p $DEPLOY_DIR
            sudo mkdir -p $BACKUP_DIR
            
            # Extract deployment package
            cd /tmp
            tar -xzf deploy-package.tar.gz
            
            # Backup existing JAR if it exists
            if [ -f "$DEPLOY_DIR/finance-backend.jar" ]; then
              sudo cp $DEPLOY_DIR/finance-backend.jar $BACKUP_DIR/finance-backend-$TIMESTAMP.jar
            fi
            
            # Stop the service
            sudo systemctl stop finance-app || true
            
            # Copy new JAR
            sudo cp finance-backend.jar $DEPLOY_DIR/
            sudo chown ec2-user:ec2-user $DEPLOY_DIR/finance-backend.jar
            
            # Copy and setup systemd service if it doesn't exist
            if [ ! -f /etc/systemd/system/finance-app.service ]; then
              sudo cp finance-app.service /etc/systemd/system/
              sudo systemctl daemon-reload
              sudo systemctl enable finance-app
            else
              # Reload systemd if service file exists (in case it was updated)
              sudo systemctl daemon-reload
            fi
            
            # Restart the service to ensure it picks up the new JAR
            echo "Restarting finance-app service..."
            sudo systemctl restart finance-app
            
            # Wait a bit for the service to fully start
            sleep 5
            
            # Check service status
            if sudo systemctl is-active --quiet finance-app; then
              echo "✓ Service is running successfully"
              sudo systemctl status finance-app --no-pager -l || true
            else
              echo "❌ Service failed to start!"
              sudo systemctl status finance-app --no-pager -l || true
              sudo journalctl -u finance-app -n 50 --no-pager || true
              exit 1
            fi
            
            # Cleanup
            rm -rf /tmp/deploy-package.tar.gz /tmp/deploy-package
            
            echo "Deployment completed successfully!"
          EOF

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key \
              ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
              'bash -s' << 'VERIFY_EOF'
            echo "=== Verifying finance-app service ==="
            
            # Check if service is active
            if sudo systemctl is-active --quiet finance-app; then
              echo "✓ Service is active"
            else
              echo "❌ Service is not active!"
              sudo systemctl status finance-app --no-pager -l || true
              exit 1
            fi
            
            # Check if service is enabled
            if sudo systemctl is-enabled --quiet finance-app; then
              echo "✓ Service is enabled"
            else
              echo "⚠️  Service is not enabled (will not start on boot)"
            fi
            
            # Show service status
            echo ""
            echo "=== Service Status ==="
            sudo systemctl status finance-app --no-pager -l || true
            
            # Show recent logs
            echo ""
            echo "=== Recent Service Logs ==="
            sudo journalctl -u finance-app -n 20 --no-pager || true
            
            # Check if port is listening (assuming default Spring Boot port 8080)
            echo ""
            echo "=== Port Check ==="
            if sudo netstat -tlnp 2>/dev/null | grep ":8080 " || sudo ss -tlnp 2>/dev/null | grep ":8080 "; then
              echo "✓ Port 8080 is listening"
            else
              echo "⚠️  Port 8080 is not listening (service may still be starting)"
            fi
            
            echo ""
            echo "✓ Deployment verification completed successfully!"
          VERIFY_EOF

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -rf deploy-package deploy-package.tar.gz
